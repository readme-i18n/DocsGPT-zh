---

title: 通过 Webhook 触发代理
description: 了解如何使用 Webhook 实现 DocsGPT 代理的自动化集成，用于异步任务执行。
---

import { Callout, Tabs } from 'nextra/components';

# 通过 Webhook 触发代理

代理 Webhook 提供了一种强大的机制，可以从外部系统触发代理的执行。与提供即时响应的直接 API 不同，Webhook 专为**异步**操作设计。当您调用 Webhook 时，DocsGPT 会将代理任务加入后台处理队列，并立即返回一个 `task_id`。随后您可以使用此 ID 轮询任务结果。

这种工作流程非常适合需要快速初始响应（例如表单提交）的服务集成，也适用于触发长时间运行的任务而无需保持客户端连接。

每个代理都有其唯一的 Webhook URL，该 URL 可通过 DocsGPT 用户界面的代理编辑页面生成。此 URL 包含用于身份验证的安全令牌。

### API 端点

- **Webhook URL:** `http://localhost:7091/api/webhooks/agents/{AGENT_WEBHOOK_TOKEN}`
- **任务状态 URL:** `http://localhost:7091/api/task_status`

<Callout type="info">
DocsGPT 云服务请使用 `https://gptcloud.arc53.com/` 作为基础 URL。
</Callout>

如需更多技术细节，您可以查阅云版本或本地实例提供的 API swagger 文档。

---

## Webhook 工作流程

该流程包含两个主要步骤：触发任务和轮询结果。

### 步骤1：触发Webhook

向代理的唯一webhook URL发送HTTP `POST`请求并携带所需负载。该负载结构应与代理提示词及工具的设计处理要求相匹配。

-   **方法:** `POST`
-   **响应:** 包含`task_id`的JSON对象。示例：`{"task_id": "a1b2c3d4-e5f6-..."}`

<Tabs items={['cURL', 'Python', 'JavaScript']}>
  <Tabs.Tab>
    ```bash
    curl -X POST \
      http://localhost:7091/api/webhooks/agents/your_webhook_token \
      -H "Content-Type: application/json" \
      -d '{"question": "Your message to agent"}'
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```python
    import requests

    WEBHOOK_URL = "http://localhost:7091/api/webhooks/agents/your_webhook_token"
    payload = {"question": "Your message to agent"}

    try:
        response = requests.post(WEBHOOK_URL, json=payload)
        response.raise_for_status()
        task_id = response.json().get("task_id")
        print(f"Task successfully created with ID: {task_id}")
    except requests.exceptions.RequestException as e:
        print(f"Error triggering webhook: {e}")
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```javascript
    const webhookUrl = 'http://localhost:7091/api/webhooks/agents/your_webhook_token';
    const payload = { question: 'Your message to agent' };

    async function triggerWebhook() {
      try {
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        if (!response.ok) throw new Error(`HTTP error! ${response.status}`);
        const data = await response.json();
        console.log(`Task successfully created with ID: ${data.task_id}`);
        return data.task_id;
      } catch (error) {
        console.error('Error triggering webhook:', error);
      }
    }
    
    triggerWebhook();
    ```
  </Tabs.Tab>
</Tabs>

### 步骤2：轮询结果

获取`task_id`后，定期向`/api/task_status`端点发送`GET`请求，直到任务`status`变为`SUCCESS`或`FAILURE`。

- **`status`**: 任务当前状态（`PENDING`、`STARTED`、`SUCCESS`、`FAILURE`）。
- **`result`**: 代理的最终输出，当状态为`SUCCESS`或`FAILURE`时可用。

<Tabs items={['cURL', 'Python', 'JavaScript']}>
  <Tabs.Tab>
    ```bash
    # Replace the task_id with the one you received
    curl http://localhost:7091/api/task_status?task_id=YOUR_TASK_ID
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```python
    import requests
    import time

    STATUS_URL = "http://localhost:7091/api/task_status"
    task_id = "YOUR_TASK_ID"

    while True:
        response = requests.get(STATUS_URL, params={"task_id": task_id})
        data = response.json()
        status = data.get("status")
        print(f"Current task status: {status}")

        if status in ["SUCCESS", "FAILURE"]:
            print("Final Result:")
            print(data.get("result"))
            break
        
        time.sleep(2)
    ```
  </Tabs.Tab>
  <Tabs.Tab>
    ```javascript
    const statusUrl = 'http://localhost:7091/api/task_status';
    const taskId = 'YOUR_TASK_ID';

    const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

    async function pollForResult() {
      while (true) {
        const response = await fetch(`${statusUrl}?task_id=${taskId}`);
        const data = await response.json();
        const status = data.status;
        console.log(`Current task status: ${status}`);

        if (status === 'SUCCESS' || status === 'FAILURE') {
          console.log('Final Result:', data.result);
          break;
        }
        await sleep(2000);
      }
    }

    pollForResult();
    ```
  </Tabs.Tab>
</Tabs>